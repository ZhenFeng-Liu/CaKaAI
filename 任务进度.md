# 任务进度

## 任务描述
老用户更新到新版本后，菜单没有及时更新

## 实施检查清单：
1. [修改App.tsx，在版本更新检查后添加权限刷新逻辑, review:true]
2. [增强usePermissions hook，添加权限验证和刷新功能, review:true]
3. [在App.tsx中，token不存在或过期时自动跳转到登录页, review:true]
4. [确保所有受保护路由都依赖isAuthenticated状态，未认证时不渲染主界面, review:false]
5. [修改Sidebar.tsx，在权限检查失败时自动触发刷新, review:true]
6. [优化AppUpdater.ts，改进版本更新时的权限处理策略, review:true]
7. [添加权限刷新状态管理，提供加载状态反馈, review:true]
8. [在用户界面添加手动刷新权限的选项, review:true]
9. [添加权限同步失败的降级处理机制, review:true]

## 当前执行步骤
> 正在执行: "步骤3: 在App.tsx中，token不存在或过期时自动跳转到登录页" (审查需求: review:true, 状态: 初步完成)

## 任务进度

### [2024-12-19 执行步骤1]
- **步骤**: 检查清单第1项：在App.tsx中实现版本号自动检测，若检测到升级则设置requireReloginAfterUpdate标记并触发清理流程 (初步完成, 审查需求: review:true)
- **修改**:
  - 增强checkVersionAndRefreshPermissions函数，检测到lastVersion !== currentVersion时，设置'requireReloginAfterUpdate'为'true'，并主动调用checkAuth()，确保升级后立即清理缓存并跳转登录。
  - 原有权限刷新逻辑在升级后首次启动时不再执行，避免未登录状态下拉取权限。
- **更改摘要**: 现在应用检测到版本升级后，会自动标记需重新登录，并立即清理所有前端缓存和用户数据，强制跳转到登录页，确保用户重新登录并拉取最新权限。
- **原因**: 执行计划步骤1，确保升级后环境干净，权限和数据与新版本兼容。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认）

### [2024-12-19 执行步骤2]
- **步骤**: 检查清单第2项：在checkAuth流程中，检测requireReloginAfterUpdate时，清理localStorage、IndexedDB等所有前端缓存和用户数据，跳转到登录页 (初步完成, 审查需求: review:true)
- **修改**:
  - 在checkAuth中，检测到requireReloginAfterUpdate时，除清理localStorage外，动态引入db对象并清空所有IndexedDB表，确保所有前端缓存和用户数据被彻底清理。
  - 清理完成后，强制跳转到登录页。
- **更改摘要**: 现在升级后首次启动时，所有前端缓存（localStorage、IndexedDB）都会被彻底清理，用户被强制要求重新登录，确保环境干净。
- **原因**: 执行计划步骤2，防止老版本遗留数据影响新版本权限和功能。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认）
- **微小修正**: 增强checkVersionAndRefreshPermissions函数，fetch('/package.json')后增加内容类型和结构校验，若返回非JSON或解析失败，优雅降级为默认版本号并输出详细警告，防止异常中断。

### [2024-12-19 执行步骤3]
- **步骤**: 检查清单第3项：登录页登录成功后，强制拉取最新用户信息和菜单权限，存入localStorage，并派发权限变更事件 (初步完成, 审查需求: review:true)
- **修改**:
  - 登录成功后，fetchAndProcessUserInfo始终强制拉取并覆盖用户信息和权限，拉取失败时阻止进入主界面并弹窗提示。
  - 增强异常处理，确保权限数据一致性。
- **更改摘要**: 现在登录后无论本地缓存如何，都会强制拉取并刷新用户信息和权限，确保菜单权限为最新，异常时阻止进入主界面。
- **原因**: 执行计划步骤3，防止因缓存或网络异常导致权限脏读。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认）

### [2024-12-19 执行步骤4]
- **步骤**: 检查清单第4项：确保所有受保护路由都依赖isAuthenticated状态，未认证时不渲染主界面 (初步完成, 审查需求: review:false)
- **修改**:
  - App.tsx主界面渲染逻辑已实现：isAuthenticated为true时渲染<MainContent />，否则渲染<LoginPage />，未认证用户无法访问主界面。
- **更改摘要**: 受保护路由和主界面均依赖isAuthenticated状态，未认证时不会渲染主界面，安全性和体验均有保障。
- **原因**: 执行计划步骤4，确保未认证用户无法访问受保护内容。
- **阻碍**: 无
- **状态**: 等待直接确认 

### [2024-12-19 执行步骤5]
- **步骤**: 检查清单第5项：修改Sidebar.tsx，在权限检查失败时自动触发刷新 (初步完成, 审查需求: review:true)
- **修改**:
  - MainMenus组件中，若所有菜单权限均为false（即authorizedIcons为空），自动派发permissions-changed事件，触发全局权限刷新。
  - 可选弹窗提示代码已预留，便于后续增强。
- **更改摘要**: 现在Sidebar在检测到无任何可用菜单权限时，会自动尝试刷新权限，提升了权限同步的健壮性。
- **原因**: 执行计划步骤5，防止因权限脏读导致Sidebar菜单丢失。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认） 

### [2024-12-19 执行步骤6]
- **步骤**: 检查清单第6项：优化AppUpdater.ts，改进版本更新时的权限处理策略 (初步完成, 审查需求: review:true)
- **修改**:
  - showUpdateDialog中，在设置requireReloginAfterUpdate标记的同时，主动通过mainWindow.webContents.send('require-permission-refresh')通知前端刷新权限，并在主进程日志中记录。
- **更改摘要**: 现在每次版本更新后，前端会被主动通知刷新权限，确保升级后权限同步及时。
- **原因**: 执行计划步骤6，提升升级后权限同步的可靠性。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认） 

### [2024-12-19 执行步骤7]
- **步骤**: 检查清单第7项：添加权限刷新状态管理，提供加载状态反馈 (初步完成, 审查需求: review:true)
- **修改**:
  - 在App.tsx中监听'require-permission-refresh'事件，触发全局权限刷新时显示Spin加载提示，调用fetchAndProcessUserInfo并在loading期间展示"正在刷新权限..."，刷新完成后关闭提示。
- **更改摘要**: 现在权限刷新时用户会看到全局加载反馈，提升了操作透明度和体验。
- **原因**: 执行计划步骤7，优化权限刷新过程的用户感知。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认） 

### [2024-12-19 执行步骤8]
- **步骤**: 检查清单第8项：在用户界面添加手动刷新权限的选项 (初步完成, 审查需求: review:true)
- **修改**:
  - 在Sidebar底部添加"刷新权限"按钮，点击后派发'require-permission-refresh'事件，支持多语言，配合全局加载提示。
- **更改摘要**: 现在用户可在主界面Sidebar底部一键手动刷新权限，提升了权限同步的主动性和可控性。
- **原因**: 执行计划步骤8，便于用户在遇到权限异常时自助修复。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认） 
- **子提示迭代**: 按用户要求，将Sidebar底部"刷新权限"按钮的图标更换为Ant Design的ReloadOutlined，提升一致性和辨识度。

### [2024-12-19 执行步骤9]
- **步骤**: 检查清单第9项：添加权限同步失败的降级处理机制 (初步完成, 审查需求: review:true)
- **修改**:
  - 在fetchAndProcessUserInfo失败时，自动清空localStorage.menuPermissions和userInfo，并派发permissions-changed事件，弹窗提示"权限同步失败，已清空本地权限，请检查网络或重新登录"。
  - 在App.tsx的handlePermissionRefresh中，若权限同步失败也执行上述降级处理。
- **更改摘要**: 现在权限同步失败时会自动清空本地权限缓存，界面立即反映无权限状态，并有明确提示，防止脏数据和误操作。
- **原因**: 执行计划步骤9，提升权限同步的健壮性和用户体验。
- **阻碍**: 无
- **状态**: 等待后续处理（审查或直接确认）

[2024-05-11 任务进度追加]
* 步骤：1. 修改 WindowService.ts 的主窗口关闭事件逻辑，无论是否启用托盘，点击关闭按钮都直接执行 app.quit()（审查需求: review:true, 状态：初步完成，进入交互式审查）
    * 修改：[src/main/services/WindowService.ts] 主窗口关闭事件移除所有托盘判断，直接调用 app.quit()
    * 更改摘要：主窗口关闭即完全退出应用，托盘自动销毁
    * 原因：满足"点击关闭窗口，托盘也自动退出"需求
    * 阻碍：无
    * 用户确认状态：待确认
    * 交互式审查脚本退出信息: 待定
* 步骤：2. 复查 TrayService，确保 app.quit() 时托盘能自动销毁，无需额外处理（审查需求: review:false, 状态：直接确认）
    * 修改：无代码更改，仅复查
    * 更改摘要：确认 app.quit() 时托盘自动销毁
    * 原因：执行计划步骤2
    * 阻碍：无
    * 用户确认状态：待确认
    * 交互式审查脚本退出信息: 不适用
* 步骤：3. 主窗口关闭时先清除localStorage的token再退出应用（审查需求: review:true, 状态：初步完成，进入交互式审查）
    * 修改：[src/main/services/WindowService.ts] 主窗口关闭事件中增加 executeJavaScript("localStorage.removeItem('token')")
    * 更改摘要：主窗口关闭时自动清除token，确保安全退出
    * 原因：满足"关闭窗口时清除token"需求
    * 阻碍：无
    * 用户确认状态：待确认
    * 交互式审查脚本退出信息: 待定

[2024-12-19 新增执行步骤]
* 步骤：主界面挂载时自动拉取菜单并全局更新（审查需求: review:false, 状态：初步完成，等待直接确认）
    * 修改：[src/renderer/src/App.tsx] 主界面组件useEffect中，isAuthenticated为true时自动调用menuApi.query()，拉取菜单并通过MenuContext全局管理，所有依赖组件可自动获取最新菜单数据。
    * 更改摘要：每次进入主界面都会自动拉取并更新菜单，确保菜单数据为最新，提升数据一致性和用户体验。
    * 原因：满足"每次进入渲染主界面都及时获取一次菜单并更新菜单数据"的需求。
    * 阻碍：无
    * 用户确认状态：待确认
    * 交互式审查脚本退出信息: 不适用
    * 测试建议：1. 登录后进入主界面，观察菜单是否为最新。2. 后台修改菜单后重新进入主界面，菜单应自动刷新。3. 菜单拉取失败时应有错误日志输出，主界面不应崩溃。